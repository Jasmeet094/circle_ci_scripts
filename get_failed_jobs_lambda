import json
import http.client
import os

def get_pipeline_ids():
    pipeline_ids = []
    initial_url = "/api/v2/pipeline?org-slug=gh/finexioinc"
    headers = {"Circle-Token": os.getenv("API_TOKEN")}  # Using environment variable

    conn = http.client.HTTPSConnection("circleci.com")
    try:
        while True:
            conn.request("GET", initial_url, headers=headers)
            res = conn.getresponse()
            if res.status != 200:
                print(f"Error: Failed to fetch data (Status Code: {res.status})")
                return None

            data = res.read().decode("utf-8")
            json_data = json.loads(data)

            for pipeline in json_data.get("items", []):
                pipeline_id = pipeline["id"]
                pipeline_ids.append(pipeline_id)

            if len(pipeline_ids) >= 100 or "next_page_token" not in json_data:
                break

            initial_url = f"/api/v2/pipeline?org-slug=gh/finexioinc&page-token={json_data['next_page_token']}"
    except Exception as e:
        print(f"Error: {e}")
        return None
    finally:
        conn.close()

    return pipeline_ids

def get_workflow_ids(pipeline_id):
    conn = http.client.HTTPSConnection("circleci.com")
    headers = {"Circle-Token": os.getenv("API_TOKEN")}  # Using environment variable
    workflow_ids = []

    try:
        conn.request("GET", f"/api/v2/pipeline/{pipeline_id}/workflow", headers=headers)
        res = conn.getresponse()
        if res.status != 200:
            print(f"Error: Failed to fetch data for pipeline {pipeline_id} (Status Code: {res.status})")
            return []

        data = res.read().decode("utf-8")
        json_data = json.loads(data)

        for item in json_data.get("items", []):
            workflow_ids.append(item["id"])
    except Exception as e:
        print(f"Error: {e}")
        return []
    finally:
        conn.close()

    return workflow_ids

def get_job_details(workflow_id):
    conn = http.client.HTTPSConnection("circleci.com")
    headers = {"Circle-Token": os.getenv("API_TOKEN")}  # Using environment variable
    job_details = []

    try:
        conn.request("GET", f"/api/v2/workflow/{workflow_id}/job", headers=headers)
        res = conn.getresponse()
        if res.status != 200:
            print(f"Error: Failed to fetch job details for workflow {workflow_id} (Status Code: {res.status})")
            return []

        data = res.read().decode("utf-8")
        json_data = json.loads(data)

        for item in json_data.get("items", []):
            job_details.append(item)
    except Exception as e:
        print(f"Error: {e}")
        return []
    finally:
        conn.close()

    return job_details

def lambda_handler(event, context):
    pipeline_ids = get_pipeline_ids()
    if pipeline_ids:
        response_data = []
        counter = 1
        for pipeline_id in pipeline_ids:
            workflow_ids = get_workflow_ids(pipeline_id)
            if workflow_ids:
                for workflow_id in workflow_ids:
                    failed_jobs = []
                    job_details = get_job_details(workflow_id)
                    if job_details:
                        for job_detail in job_details:
                            if job_detail['status'] == 'failed':
                                failed_jobs.append({'id': job_detail['id'], 'job_number': job_detail['job_number'], 'status': job_detail['status']})

                    if failed_jobs:
                        workflow_data = {'Workflow ID': workflow_id, 'Failed Jobs': failed_jobs}
                        response_data.append(workflow_data)
                        counter += 1

        if response_data:
            return {
                'statusCode': 200,
                'body': json.dumps(response_data)
            }
        else:
            return {
                'statusCode': 404,
                'body': json.dumps('No failed jobs found')
            }
    else:
        return {
            'statusCode': 500,
            'body': json.dumps('Failed to fetch pipeline IDs')
        }
